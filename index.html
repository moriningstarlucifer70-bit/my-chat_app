<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Mega Chat & Live Call</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', sans-serif; background: #e5ddd5; display: flex; justify-content: center; align-items: center; height: 100vh; }
        #login-screen { background: white; padding: 30px; border-radius: 12px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        #chat-screen { display: none; width: 420px; height: 90vh; background: white; flex-direction: column; border-radius: 12px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        header { background: #075e54; color: white; padding: 15px; text-align: center; font-weight: bold; font-size: 1.1em; }
        .status-bar { background: #054d44; color: #afffdf; padding: 6px; font-size: 12px; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .dot { height: 9px; width: 9px; background: #25d366; border-radius: 50%; box-shadow: 0 0 8px #25d366; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 0.4; } 50% { opacity: 1; transform: scale(1.2); } 100% { opacity: 0.4; } }
        #messages { flex: 1; overflow-y: auto; padding: 15px; background: #efe7de; display: flex; flex-direction: column; gap: 12px; }
        .msg { padding: 10px; border-radius: 10px; max-width: 85%; font-size: 14px; background: white; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .mine { background: #dcf8c6; align-self: flex-end; }
        .footer { padding: 12px; background: #f0f0f0; display: flex; gap: 8px; align-items: center; }
        input { flex: 1; padding: 10px 15px; border-radius: 20px; border: 1px solid #ddd; outline: none; }
        button { border: none; padding: 10px 15px; border-radius: 20px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .send-btn { background: #128c7e; color: white; }
        .mic-btn { background: #ea4335; color: white; font-size: 18px; }
        .call-btn { background: #34b7f1; color: white; }
        button:active { transform: scale(0.95); opacity: 0.8; }
    </style>
</head>
<body>

    <div id="login-screen">
        <h2 style="color:#075e54; margin-bottom:15px;">Enter Chat</h2>
        <input type="text" id="username" placeholder="Nickname..." style="width:100%; margin-bottom:15px; padding:10px;">
        <button onclick="start()" style="background:#128c7e; color:white; width:100%;">Join Room</button>
    </div>

    <div id="chat-screen">
        <header id="h-name">Global Group</header>
        <div class="status-bar"><span class="dot"></span> <span id="online-count">0 users online</span></div>
        <div id="messages"></div>
        <div class="footer">
            <input type="text" id="msg-input" placeholder="Type a message...">
            <button class="send-btn" onclick="send()">Send</button>
            <button class="mic-btn" id="record-btn" title="Hold to record">ðŸŽ¤</button>
            <button class="call-btn" onclick="startCall()">ðŸ“ž Call</button>
        </div>
    </div>

    <script>
        const socket = io('http://localhost:3000');
        let currentUser = "", localStream, peerConnection;
        const config = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };

        function start() {
            const name = document.getElementById('username').value;
            if(name.trim()) {
                currentUser = name;
                socket.emit('add user', name);
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('chat-screen').style.display = 'flex';
            }
        }

        // --- WEB RTC (LIVE CALL) LOGIC ---
        async function createPeerConnection() {
            peerConnection = new RTCPeerConnection(config);
            peerConnection.onicecandidate = (e) => {
                if (e.candidate) socket.emit('new message', { type: 'candidate', candidate: e.candidate });
            };
            peerConnection.ontrack = (e) => {
                const audio = new Audio(); audio.srcObject = e.streams[0]; audio.play();
            };
            localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
        }

        async function startCall() {
            await createPeerConnection();
            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);
            socket.emit('new message', { type: 'offer', sdp: offer });
            addMessage('System', 'Calling...', false);
        }

        socket.on('new message', async (data) => {
            const msg = data.message;
            if (msg.type === 'offer') {
                await createPeerConnection();
                await peerConnection.setRemoteDescription(new RTCSessionDescription(msg.sdp));
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);
                socket.emit('new message', { type: 'answer', sdp: answer });
                addMessage('System', 'Incoming Call Connected', false);
            } else if (msg.type === 'answer') {
                await peerConnection.setRemoteDescription(new RTCSessionDescription(msg.sdp));
            } else if (msg.type === 'candidate') {
                if (peerConnection) await peerConnection.addIceCandidate(new RTCIceCandidate(msg.candidate));
            } else {
                addMessage(data.username, data.message, false);
            }
        });

        // --- GENERAL CHAT LOGIC ---
        function send() {
            const input = document.getElementById('msg-input');
            if(input.value.trim()) {
                socket.emit('new message', input.value);
                addMessage('You', input.value, true);
                input.value = "";
            }
        }

        function addMessage(u, t, isMe) {
            const div = document.createElement('div');
            div.className = `msg ${isMe ? 'mine' : ''}`;
            div.innerHTML = `<strong>${u}</strong><br>${t}`;
            document.getElementById('messages').appendChild(div);
            document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
        }

        socket.on('user count', c => document.getElementById('online-count').innerText = c + " users online");

        // --- AUDIO MESSAGE LOGIC ---
        let mediaRecorder, audioChunks = [];
        const recordBtn = document.getElementById('record-btn');
        recordBtn.onmousedown = async () => {
            const s = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(s);
            audioChunks = [];
            mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
            mediaRecorder.onstop = () => {
                const blob = new Blob(audioChunks, { type: 'audio/webm' });
                const r = new FileReader(); r.readAsDataURL(blob);
                r.onloadend = () => {
                    const html = `<audio controls src="${r.result}"></audio>`;
                    socket.emit('new message', html);
                    addMessage('You', html, true);
                };
            };
            mediaRecorder.start();
            recordBtn.innerText = "ðŸ”´";
        };
        recordBtn.onmouseup = () => {
            if(mediaRecorder) mediaRecorder.stop();
            recordBtn.innerText = "ðŸŽ¤";
        };
    </script>
</body>
</html>